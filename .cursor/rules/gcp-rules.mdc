---
alwaysApply: true
---
# GCP Cloud Functions Operations Guide

## ğŸ“‹ GCP Configuration

**Project Details:**
- **Project ID**: `snapnest-453114`
- **Service Account**: `jerseysfever@snapnest-453114.iam.gserviceaccount.com`
- **Service Account File**: `gcp-key/snapnest-453114-c1b3bb4db875.json` (æœ¬åœ°æ–‡ä»¶ï¼Œä¸æäº¤åˆ° Git)
- **Client ID**: `113248339391559399839`

**âš ï¸ é‡è¦ï¼šService Account æ–‡ä»¶ç®¡ç†**
- âœ… æ–‡ä»¶ä¿ç•™åœ¨æœ¬åœ°ï¼Œç”¨äº GCP è®¤è¯
- âŒ æ–‡ä»¶å·²æ·»åŠ åˆ° `.gitignore`ï¼Œä¸ä¼šæäº¤åˆ° Git
- ğŸ” å¦‚æœæ–‡ä»¶ä¸¢å¤±ï¼Œéœ€è¦ä» GCP Console é‡æ–°ä¸‹è½½

---

## ğŸ” Authentication Setup

### Set Service Account (Required Before Any Operations)

```bash
# Set environment variable
export GOOGLE_APPLICATION_CREDENTIALS="gcp-key/snapnest-453114-c1b3bb4db875.json"

# Activate service account
gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"

# Set project
gcloud config set project snapnest-453114

# Verify configuration
gcloud config list
```

**Expected Output:**
```
[core]
account = jerseysfever@snapnest-453114.iam.gserviceaccount.com
project = snapnest-453114
```

---

## â˜ï¸ Cloud Functions Overview

### Available Functions

| Function Name | Region | Runtime | Status | Purpose |
|--------------|--------|---------|--------|---------|
| `snapnest-generative-flux` | asia-southeast1 | python312 | ACTIVE | Flux å›¾åƒç”Ÿæˆ |
| `snapnest-generative-gemini-image` | asia-southeast1 | python312 | ACTIVE | Gemini å›¾åƒç”Ÿæˆ |
| `snapnest-generative-gemini25-flash` | asia-southeast1 | python312 | ACTIVE | Gemini 2.5 Flash å›¾åƒç”Ÿæˆ |
| `snapnest-generative-imagen` | asia-southeast1 | python312 | ACTIVE | Imagen å›¾åƒç”Ÿæˆ |
| `snapnest-generative-storage` | asia-southeast1 | python312 | ACTIVE | å­˜å‚¨æœåŠ¡ |
| `snapnest-generative-veo` | asia-southeast1 | python312 | ACTIVE | Veo è§†é¢‘ç”Ÿæˆ |
| `snapnest-professional-stitcher` | asia-southeast1 | python312 | ACTIVE | ä¸“ä¸šæ‹¼æ¥æœåŠ¡ |

### Function URLs

- **snapnest-generative-flux**: `https://snapnest-generative-flux-zw2y4q6kyq-as.a.run.app`
- **snapnest-generative-gemini-image**: `https://snapnest-generative-gemini-image-zw2y4q6kyq-as.a.run.app`
- **snapnest-generative-gemini25-flash**: `https://snapnest-generative-gemini25-flash-zw2y4q6kyq-as.a.run.app`
- **snapnest-generative-imagen**: `https://snapnest-generative-imagen-zw2y4q6kyq-as.a.run.app`
- **snapnest-generative-storage**: `https://snapnest-generative-storage-zw2y4q6kyq-as.a.run.app`
- **snapnest-generative-veo**: `https://snapnest-generative-veo-zw2y4q6kyq-as.a.run.app`
- **snapnest-professional-stitcher**: `https://snapnest-professional-stitcher-zw2y4q6kyq-as.a.run.app`

---

## ğŸš€ Deployment Operations

### List All Functions

```bash
# List all functions
gcloud functions list

# List with details
gcloud functions list --format="table(name,status,region,trigger.httpsTrigger.url)"

# List functions in specific region
gcloud functions list --regions=asia-southeast1
gcloud functions list --regions=us-central1
```

### Get Function Information

```bash
# Get function details
gcloud functions describe <function-name> --gen2 --region=<region>

# Get function URL
gcloud functions describe <function-name> --gen2 --region=<region> --format="value(serviceConfig.uri)"

# Get function logs
gcloud functions logs read <function-name> --gen2 --region=<region> --limit=50
```

### Deploy Function

**Before deploying, ensure:**
1. âœ… Service account is activated
2. âœ… Correct project is set
3. âœ… Required environment variables are set
4. âœ… You're in the function directory

**Deployment Steps:**

```bash
# 1. Navigate to function directory
cd cloud-functions/<function-name>

# 2. Set required environment variables (if needed)
export GEMINI_API_KEY="your-key"
export ALIYUN_ACCESS_KEY_ID="your-key"
export ALIYUN_ACCESS_KEY_SECRET="your-secret"
export ALIYUN_INSTANCE_NAME="your-instance"

# 3. Run deployment script
./deploy.sh

# OR deploy manually
gcloud functions deploy <function-name> \
  --gen2 \
  --region=<region> \
  --runtime=<runtime> \
  --entry-point=<entry-point> \
  --trigger-http \
  --allow-unauthenticated \
  --memory=<memory> \
  --timeout=<timeout> \
  --set-env-vars="KEY=value" \
  --source=.
```

### Function-Specific Deployment

#### 1. snapnest-generative-gemini-image (Python)

```bash
cd cloud-functions/snapnest-generative-gemini-image

# Required env vars (æ ¹æ®å®é™…éœ€è¦è®¾ç½®)
export GEMINI_API_KEY="your-key"

./deploy.sh
```

**Deployment Config:**
- Region: `asia-southeast1`
- Runtime: `python312`
- Memory: `1Gi`
- Timeout: `540s`
- Max Instances: `100`

#### 2. snapnest-generative-flux (Python)

```bash
cd cloud-functions/snapnest-generative-flux

# Required env vars (æ ¹æ®å®é™…éœ€è¦è®¾ç½®)
./deploy.sh
```

**Deployment Config:**
- Region: `asia-southeast1`
- Runtime: `python312`
- Memory: `1024M`
- Timeout: `540s`
- Max Instances: `50`

#### 3. snapnest-professional-stitcher (Python)

```bash
cd cloud-functions/snapnest-professional-stitcher

# Required env vars (æ ¹æ®å®é™…éœ€è¦è®¾ç½®)
./deploy.sh
```

**Deployment Config:**
- Region: `asia-southeast1`
- Runtime: `python312`
- Memory: `512M`
- Timeout: `60s`
- Max Instances: `34`

---

## ğŸ“Š Monitoring & Debugging

### View Function Logs

```bash
# View recent logs
gcloud functions logs read <function-name> --gen2 --region=<region> --limit=50

# Follow logs in real-time
gcloud functions logs read <function-name> --gen2 --region=<region> --follow

# Filter logs by severity
gcloud functions logs read <function-name> --gen2 --region=<region> --severity=ERROR

# View logs for specific time range
gcloud functions logs read <function-name> --gen2 --region=<region> \
  --start-time="2025-01-01T00:00:00Z" \
  --end-time="2025-01-02T00:00:00Z"
```

### Test Function Locally

```bash
# For Node.js functions
cd cloud-functions/<function-name>
npm install
node test-local.js

# For Python functions
cd cloud-functions/<function-name>
pip install -r requirements.txt
python test-local.py
```

### Check Function Status

```bash
# Get function status
gcloud functions describe <function-name> --gen2 --region=<region> \
  --format="value(state)"

# Get function metrics
gcloud functions describe <function-name> --gen2 --region=<region> \
  --format="value(serviceConfig.availableMemory,serviceConfig.timeoutSeconds)"
```

---

## ğŸ”§ Common Operations

### Update Function Configuration

```bash
# Update memory
gcloud functions deploy <function-name> \
  --gen2 \
  --region=<region> \
  --memory=4GB

# Update timeout
gcloud functions deploy <function-name> \
  --gen2 \
  --region=<region> \
  --timeout=600s

# Update max instances
gcloud functions deploy <function-name> \
  --gen2 \
  --region=<region> \
  --max-instances=20

# Update environment variables
gcloud functions deploy <function-name> \
  --gen2 \
  --region=<region> \
  --update-env-vars="KEY1=value1,KEY2=value2"
```

### Delete Function

```bash
# Delete function
gcloud functions delete <function-name> --gen2 --region=<region>

# Delete with confirmation
gcloud functions delete <function-name> --gen2 --region=<region> --quiet
```

### Invoke Function

```bash
# Invoke function via gcloud
gcloud functions call <function-name> \
  --gen2 \
  --region=<region> \
  --data='{"key":"value"}'

# Or use curl
curl -X POST \
  https://<region>-snapnest-453114.cloudfunctions.net/<function-name> \
  -H "Content-Type: application/json" \
  -d '{"key":"value"}'
```

---

## ğŸ“ Project Structure

```
gcp-key/
â”œâ”€â”€ snapnest-453114-c1b3bb4db875.json       # Service account key
â”‚
cloud-functions/                              # Cloud Functions ä»£ç ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
â”œâ”€â”€ snapnest-generative-gemini-image/        # Gemini å›¾åƒç”Ÿæˆ
â”‚   â”œâ”€â”€ deploy.sh
â”‚   â”œâ”€â”€ main.py
â”‚   â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ snapnest-generative-flux/                 # Flux å›¾åƒç”Ÿæˆ
â”‚   â”œâ”€â”€ deploy.sh
â”‚   â”œâ”€â”€ main.py
â”‚   â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ snapnest-generative-gemini25-flash/       # Gemini 2.5 Flash
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ snapnest-generative-imagen/               # Imagen å›¾åƒç”Ÿæˆ
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ snapnest-generative-storage/              # å­˜å‚¨æœåŠ¡
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ snapnest-generative-veo/                  # Veo è§†é¢‘ç”Ÿæˆ
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ snapnest-professional-stitcher/           # ä¸“ä¸šæ‹¼æ¥æœåŠ¡
    â””â”€â”€ ...
```

---

## âš ï¸ Important Rules

### âœ… DO:
- **Always set** `GOOGLE_APPLICATION_CREDENTIALS` before operations
- **Always verify** project is set to `snapnest-453114`
- **Always check** function status before deployment
- **Always test** functions locally before deploying
- **Always check** logs after deployment
- **Use deployment scripts** (`deploy.sh`) when available

### âŒ DON'T:
- Never use wrong project ID
- Never commit service account key file
- Never deploy without setting required environment variables
- Never skip testing before deployment
- Never delete functions without backup

---

## ğŸ” Quick Reference

### Essential Commands

```bash
# Setup
export GOOGLE_APPLICATION_CREDENTIALS="gcp-key/snapnest-453114-c1b3bb4db875.json"
gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
gcloud config set project snapnest-453114

# List functions
gcloud functions list

# Deploy function
cd cloud-functions/<function-name>
./deploy.sh

# View logs
gcloud functions logs read <function-name> --gen2 --region=<region>

# Get function URL
gcloud functions describe <function-name> --gen2 --region=<region> \
  --format="value(serviceConfig.uri)"
```

### Environment Variables

**æ ¹æ®ä¸åŒçš„å‡½æ•°ï¼Œå¯èƒ½éœ€è¦è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š**
- `GEMINI_API_KEY` - Gemini API å¯†é’¥ï¼ˆç”¨äº Gemini ç›¸å…³å‡½æ•°ï¼‰
- å…¶ä»–å‡½æ•°ç‰¹å®šçš„ç¯å¢ƒå˜é‡ï¼ˆæ ¹æ®å®é™…éƒ¨ç½²éœ€è¦è®¾ç½®ï¼‰

---

## ğŸ“ Notes

- **Service account file**: `gcp-key/snapnest-453114-c1b3bb4db875.json`
  - âœ… æ–‡ä»¶ä¿ç•™åœ¨æœ¬åœ°ï¼Œç”¨äº GCP è®¤è¯
  - âŒ æ–‡ä»¶å·²æ·»åŠ åˆ° `.gitignore`ï¼Œä¸ä¼šæäº¤åˆ° Gitï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
  - ğŸ” å¦‚æœæ–‡ä»¶ä¸¢å¤±ï¼Œéœ€è¦ä» GCP Console é‡æ–°ä¸‹è½½ï¼š
    1. è®¿é—®ï¼šhttps://console.cloud.google.com/iam-admin/serviceaccounts
    2. é€‰æ‹©é¡¹ç›®ï¼š`snapnest-453114`
    3. æ‰¾åˆ° Service Accountï¼š`jerseysfever@snapnest-453114.iam.gserviceaccount.com`
    4. ç‚¹å‡» "Keys" â†’ "Add Key" â†’ "Create new key" â†’ JSON
- All functions use Gen2 (2nd generation)
- Functions are deployed with `--allow-unauthenticated` (public access)
- API documentation: `cloud-functions/API_DOCUMENTATION.md`
- Always verify service account before operations: `gcloud config list`
